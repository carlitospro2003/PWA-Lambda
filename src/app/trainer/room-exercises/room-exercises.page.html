<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button (click)="goBack()" defaultHref="/trainer/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ roomInfo?.name || 'Ejercicios de Sala' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="exercises-content">
  <div class="exercises-container">

    <!-- Información de la sala -->
    <ion-card class="room-info-card" *ngIf="roomInfo">
      <ion-card-content>
        <div class="room-info-header">
          <div>
            <h2>{{ roomInfo.name }}</h2>
            <div class="room-meta">
              <ion-chip color="primary" size="small">
                <ion-label>{{ roomInfo.code }}</ion-label>
              </ion-chip>
              <span class="members-count">{{ roomInfo.activeMembers }}/{{ roomInfo.totalMembers }} miembros</span>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Header de ejercicios con botón agregar -->
    <div class="exercises-header">
      <h3>Ejercicios Disponibles</h3>
      <ion-button 
        fill="outline" 
        size="small"
        color="primary"
        (click)="addNewExercise()">
        <ion-icon name="add" slot="start"></ion-icon>
        Agregar
      </ion-button>
    </div>

    <!-- Indicador de carga -->
    <div class="loading-state" *ngIf="isLoadingExercises">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Cargando ejercicios...</p>
    </div>

    <!-- Lista de ejercicios -->
    <div class="exercises-grid" *ngIf="!isLoadingExercises">
      <ion-card 
        class="exercise-card" 
        *ngFor="let exercise of exercises"
        (click)="viewExerciseDetail(exercise)">
        <ion-card-content>
          
          <!-- Header del ejercicio -->
          <div class="exercise-header">
            <div class="exercise-icon">
              <ion-icon [name]="getCategoryIcon(exercise.EXC_Type || '')" [color]="getCategoryColor(exercise.EXC_Type || '')"></ion-icon>
            </div>
            <div class="exercise-title-section">
              <h4>{{ exercise.EXC_Title }}</h4>
            </div>
          </div>

          <!-- Badges de categoría y dificultad -->
          <div class="exercise-badges">
            <ion-chip [color]="getCategoryColor(exercise.EXC_Type || '')" size="small" *ngIf="exercise.EXC_Type">
              {{ exercise.EXC_Type | titlecase }}
            </ion-chip>
            <ion-chip [color]="getDifficultyColor(exercise.EXC_DifficultyLevel || '')" size="small" *ngIf="exercise.EXC_DifficultyLevel">
              {{ getDifficultyText(exercise.EXC_DifficultyLevel) }}
            </ion-chip>
          </div>

          <!-- Instrucciones (si existen) -->
          <div class="exercise-description" *ngIf="exercise.EXC_Instructions">
            <p>{{ exercise.EXC_Instructions }}</p>
          </div>

          <!-- Botones de acción -->
          <div class="exercise-actions">
            <ion-button 
              expand="block" 
              fill="outline" 
              color="primary"
              (click)="viewExerciseDetail(exercise); $event.stopPropagation()">
              <ion-icon name="play-circle-outline" slot="start"></ion-icon>
              Ver Detalles
            </ion-button>
            
            <div class="action-buttons">
              <ion-button 
                fill="clear" 
                color="warning"
                (click)="editExercise(exercise); $event.stopPropagation()">
                <ion-icon name="create-outline" slot="icon-only"></ion-icon>
              </ion-button>
              
              <ion-button 
                fill="clear" 
                color="danger"
                (click)="deleteExercise(exercise); $event.stopPropagation()">
                <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </div>

        </ion-card-content>
      </ion-card>
    </div>

    <!-- Estado vacío si no hay ejercicios -->
    <div class="empty-state" *ngIf="!isLoadingExercises && exercises.length === 0">
      <ion-icon name="fitness-outline" class="empty-icon"></ion-icon>
      <h3>No hay ejercicios en esta sala</h3>
      <p>Agrega ejercicios para que los miembros puedan entrenar</p>
      <ion-button expand="block" (click)="addNewExercise()">
        <ion-icon name="add" slot="start"></ion-icon>
        Agregar Primer Ejercicio
      </ion-button>
    </div>

  </div>
</ion-content>

<!-- Modal de Edición -->
<ion-modal [isOpen]="isEditModalOpen" (didDismiss)="closeEditModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Editar Ejercicio</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeEditModal()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div class="edit-form">
        
        <!-- Título -->
        <div class="form-field">
          <ion-label position="stacked">Título *</ion-label>
          <ion-input 
            [(ngModel)]="editForm.EXC_Title" 
            placeholder="Título del ejercicio"
            type="text">
          </ion-input>
        </div>

        <!-- Tipo (Select) -->
        <div class="form-field">
          <ion-label position="stacked">Tipo</ion-label>
          <ion-select 
            [(ngModel)]="editForm.EXC_Type" 
            placeholder="Selecciona el tipo"
            interface="action-sheet">
            <ion-select-option value="">Sin tipo</ion-select-option>
            <ion-select-option *ngFor="let type of exerciseTypes" [value]="type">
              {{ type }}
            </ion-select-option>
          </ion-select>
        </div>

        <!-- Dificultad (Select) -->
        <div class="form-field">
          <ion-label position="stacked">Dificultad</ion-label>
          <ion-select 
            [(ngModel)]="editForm.EXC_DifficultyLevel" 
            placeholder="Selecciona la dificultad"
            interface="action-sheet">
            <ion-select-option value="">Sin dificultad</ion-select-option>
            <ion-select-option *ngFor="let level of difficultyLevels" [value]="level.value">
              {{ level.label }}
            </ion-select-option>
          </ion-select>
        </div>

        <!-- Instrucciones -->
        <div class="form-field">
          <ion-label position="stacked">Instrucciones</ion-label>
          <ion-textarea 
            [(ngModel)]="editForm.EXC_Instructions" 
            placeholder="Describe cómo realizar el ejercicio"
            rows="4"
            autoGrow="true">
          </ion-textarea>
        </div>

        <!-- URL Video 1 -->
        <div class="form-field">
          <ion-label position="stacked">URL Video 1</ion-label>
          <ion-input 
            [(ngModel)]="editForm.EXC_URL1" 
            placeholder="https://youtube.com/..."
            type="url">
          </ion-input>
        </div>

        <!-- URL Video 2 -->
        <div class="form-field">
          <ion-label position="stacked">URL Video 2</ion-label>
          <ion-input 
            [(ngModel)]="editForm.EXC_URL2" 
            placeholder="https://youtube.com/..."
            type="url">
          </ion-input>
        </div>

        <!-- Botones -->
        <div class="modal-actions">
          <ion-button 
            expand="block" 
            color="medium"
            fill="outline"
            (click)="openFilePickerForEdit()">
            <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
            Agregar Archivos
          </ion-button>

          <ion-button 
            expand="block" 
            color="primary"
            (click)="saveExerciseFromModal()">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            Guardar Cambios
          </ion-button>
        </div>

      </div>
    </ion-content>
  </ng-template>
</ion-modal>
